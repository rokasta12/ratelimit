---
title: H3 / Nitro
description: Rate limiting for H3 and Nitro applications
---

## Installation

```bash
npm install @jf/ratelimit-h3
```

## Basic Usage

```ts
import { createApp, eventHandler } from "h3";
import { rateLimiter } from "@jf/ratelimit-h3";

const app = createApp();

app.use(
  rateLimiter({
    limit: 100,
    windowMs: 60_000,
  }),
);

app.use(eventHandler(() => "Hello!"));

export default app;
```

## Nitro Server Middleware

```ts
// server/middleware/ratelimit.ts
import { rateLimiter } from "@jf/ratelimit-h3";

export default rateLimiter({
  limit: 100,
  windowMs: 60_000,
});
```

## Options

| Option          | Type                                 | Default            | Description             |
| --------------- | ------------------------------------ | ------------------ | ----------------------- |
| `limit`         | `number \| (event) => number`        | `60`               | Max requests per window |
| `windowMs`      | `number`                             | `60000`            | Window duration in ms   |
| `algorithm`     | `'fixed-window' \| 'sliding-window'` | `'sliding-window'` | Algorithm               |
| `store`         | `RateLimitStore`                     | `MemoryStore`      | Storage backend         |
| `keyGenerator`  | `(event) => string`                  | IP-based           | Client identifier       |
| `skip`          | `(event) => boolean`                 | -                  | Skip rate limiting      |
| `handler`       | `(event, info) => void`              | 429 response       | Custom handler          |
| `dryRun`        | `boolean`                            | `false`            | Log but don't block     |
| `onRateLimited` | `(event, info) => void`              | -                  | Callback when limited   |

## Access Rate Limit Info

The rate limit info is stored in the event context:

```ts
// server/api/data.ts
export default eventHandler((event) => {
  const info = event.context.rateLimit;
  // { limit: 100, remaining: 99, reset: 1234567890 }

  return { data: "hello" };
});
```

## Custom Key Generator

```ts
app.use(
  rateLimiter({
    limit: 100,
    windowMs: 60_000,
    keyGenerator: (event) => {
      return getHeader(event, "x-user-id") ?? getRequestIP(event) ?? "unknown";
    },
  }),
);
```

## Skip Routes

```ts
app.use(
  rateLimiter({
    limit: 100,
    windowMs: 60_000,
    skip: (event) => {
      return event.path === "/health" || event.path.startsWith("/public/");
    },
  }),
);
```

## Custom Response

```ts
import { send, setResponseStatus } from "h3";

app.use(
  rateLimiter({
    limit: 100,
    windowMs: 60_000,
    handler: async (event, info) => {
      setResponseStatus(event, 429);
      return send(
        event,
        JSON.stringify({
          error: "Rate limit exceeded",
          retryAfter: Math.ceil((info.reset - Date.now()) / 1000),
        }),
      );
    },
  }),
);
```

## With Nitro and Redis

```ts
// server/plugins/ratelimit.ts
import { createStorage } from "unstorage";
import redisDriver from "unstorage/drivers/redis";
import { createUnstorageStore } from "@jf/ratelimit-unstorage";

const storage = createStorage({
  driver: redisDriver({ url: process.env.REDIS_URL }),
});

export const rateLimitStore = createUnstorageStore({ storage });

// server/middleware/ratelimit.ts
import { rateLimiter } from "@jf/ratelimit-h3";
import { rateLimitStore } from "../plugins/ratelimit";

export default rateLimiter({
  limit: 100,
  windowMs: 60_000,
  store: rateLimitStore,
});
```

## Define Rate Limiter Helper

For cleaner Nitro integration:

```ts
import { defineRateLimiter } from "@jf/ratelimit-h3";

// server/middleware/ratelimit.ts
export default defineRateLimiter({
  limit: 100,
  windowMs: 60_000,
});
```
